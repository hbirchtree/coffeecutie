targets:
  osx:
    - .
  ios:
    - .
    - x86_64
    - x86

globals:
  RUNNER: Makefile.mac-base
  CMAKE_SOURCE_DIR: $(project.src)
  CMAKE_BUILD_DIR: $(project.build)
  CMAKE_INSTALL_DIR: $(project.install)
  NATIVE_LIBRARY_DIR: $(dependencies.native-libs.root)
  COFFEE_ROOT_DIR: $(lib.root)
  BUILD_DIR: $(env:PWD)
  SOURCE_DIR: $(env:PWD)/..
  ROOT_DIR: $(env:SOURCE_DIR)/$(env:MAKEFILE_DIR)
  GENERATE_PROGRAMS: OFF
  GENERATE_TESTS: OFF
  CONFIGURATION: Debug
  HEADLESS: ON

variables:
  multi:
    root: $(env:BUILD_DIR)
  project:
    src: $(env:SOURCE_DIR)
    build: $(multi.root)
    install: $(multi.root)/build
  container:
    src: /home/coffee/project
    build: /home/coffee/build
    install: /home/coffee/out
  dep:
    root: $(project.build)/dependencies
  build:
    prettyname: Nothing
    build-type: $(env:CONFIGURATION)
  # For importing the Coffee library
  lib:
    flavor: ERROR_ABORT_DELET_THIS
    root: $(env:COFFEE_DIR)

dependencies:
  native-libs:
    type: git # type of dependency, decides procedure on how to use it
    source: https://github.com/hbirchtree/native-library-bundle.git # in case of git, online url
    root: $(dep.root)/native-libs # root is the native filesystem path

templates:
  =target: build
  =cmake-target:
    - install
  =generator: Xcode

  =cmake-opts:
    - $(env:CMAKE_SOURCE_DIR)
    - -DNATIVE_LIBRARY_DIR=$(env:NATIVE_LIBRARY_DIR)/$(build.prettyname)
    - -DCOFFEE_ROOT_DIR=$(env:COFFEE_ROOT_DIR)/$(lib.flavor)
    - -DGENERATE_PROGRAMS=$(env:GENERATE_PROGRAMS)
    - -DGENERATE_TESTS=$(env:GENERATE_TESTS)
    - -DCOFFEE_BUILD_ASSIMP=ON
    - -G'$(generator)'
    - -C"$(env:CMAKE_SOURCE_DIR)/cmake/Preload/$(preload)"
    - -DCMAKE_BUILD_TYPE=$(build.build-type)
    - -DCMAKE_INSTALL_PREFIX=$(env:CMAKE_INSTALL_DIR)/$(target-name)
    - -DCMAKE_TOOLCHAIN_FILE=$(env:CMAKE_SOURCE_DIR)/cmake/Toolchains/$(toolchain)
    - -DSKIP_GRAPHIC_TESTS=$(env:HEADLESS)
  =build.prettyname: Apple
  =compiler: Clang
  =lib.flavor: $(target-name)
  =dependencies: native-libs

  osx:
    =description: Apple OS X
    =flavor: mac-osx
    =toolchain: osx-generic_osx.toolchain.cmake
    =preload: osx-generic.cmake
    +cmake-opts:
      - -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl

  ios.*:
    =toolchain:  all-ios.toolchain.cmake
    =preload: osx-ios.cmake

  ios$:
    =description: Device-oriented build for ARM64 and ARMv7-A

  ios.x86.*:
    =description: iOS simulator build
    .*x86_64:
      +cmake-opts:
        - -DIOS_PLATFORM=SIMULATOR64
    .*x86$:
      +cmake-opts:
        - -DIOS_PLATFORM=SIMULATOR
